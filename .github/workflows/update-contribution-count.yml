name: Update Contribution Count

on:
  schedule:
    # Runs daily at 1:00 AM UTC (after snake generation)
    - cron: "0 1 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-contribution-count.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current year contribution count
        id: get_contributions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const query = `
              query($username: String!, $from: DateTime!, $to: DateTime!) {
                user(login: $username) {
                  contributionsCollection(from: $from, to: $to) {
                    contributionCalendar {
                      totalContributions
                    }
                  }
                }
              }
            `;
            
            const now = new Date();
            // Get contributions from the last 365 days (matching GitHub's "last year")
            const from = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString();
            const to = now.toISOString();
            
            const variables = {
              username: 'zashari',
              from: from,
              to: to
            };
            
            const response = await github.graphql(query, variables);
            const totalContributions = response.user.contributionsCollection.contributionCalendar.totalContributions;
            
            core.setOutput('count', totalContributions);
            console.log(`Total contributions this year: ${totalContributions}`);

      - name: Update README with contribution count
        run: |
          COUNT="${{ steps.get_contributions.outputs.count }}"
          python3 << EOF
          import re
          import os
          
          count = os.environ.get('COUNT', '0')
          
          with open('README.md', 'r') as f:
              content = f.read()
          
          # Extract the number from inside the comment and place it before the comment (visible)
          # Pattern: comment with number inside
          pattern = r'<!-- CONTRIBUTIONS_COUNT -->(\d+)<!-- /CONTRIBUTIONS_COUNT -->'
          
          # Replace: put the new count BEFORE the comment (visible) and keep the comment with count inside
          replacement = f'{count} <!-- CONTRIBUTIONS_COUNT -->{count}<!-- /CONTRIBUTIONS_COUNT -->'
          content = re.sub(pattern, replacement, content, count=1)
          
          # Cleanup: if there's already a number before the comment, remove duplicates
          # Match: number + space + number + space + comment, replace with single number + comment
          cleanup_pattern = r'(\d+)\s+\1\s+<!-- CONTRIBUTIONS_COUNT -->'
          cleanup_replacement = r'\1 <!-- CONTRIBUTIONS_COUNT -->'
          content = re.sub(cleanup_pattern, cleanup_replacement, content)
          
          with open('README.md', 'w') as f:
              f.write(content)
          EOF
        env:
          COUNT: ${{ steps.get_contributions.outputs.count }}

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --quiet README.md || git add README.md && git commit -m "Update contribution count [skip ci]" && git push

