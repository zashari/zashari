name: Update Contribution Count

on:
  schedule:
    # Runs daily at 1:00 AM UTC (after snake generation)
    - cron: "0 1 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-contribution-count.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current year contribution count
        id: get_contributions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Try two approaches to get the most accurate count

            // First query: without date parameters (uses GitHub's default "last year" calculation)
            const queryDefault = `
              query($username: String!) {
                user(login: $username) {
                  contributionsCollection {
                    contributionCalendar {
                      totalContributions
                    }
                    restrictedContributionsCount
                  }
                }
              }
            `;

            // Second query: with explicit date range
            const queryWithDates = `
              query($username: String!, $from: DateTime!, $to: DateTime!) {
                user(login: $username) {
                  contributionsCollection(from: $from, to: $to) {
                    contributionCalendar {
                      totalContributions
                    }
                    restrictedContributionsCount
                    totalCommitContributions
                    totalIssueContributions
                    totalPullRequestContributions
                    totalPullRequestReviewContributions
                  }
                }
              }
            `;

            // Query 1: Use GitHub's default calculation (no dates)
            console.log('Fetching contributions using GitHub default calculation...');
            const responseDefault = await github.graphql(queryDefault, { username: 'zashari' });
            const defaultCount = responseDefault.user.contributionsCollection.contributionCalendar.totalContributions;
            console.log(`Default calculation (no dates): ${defaultCount} contributions`);

            // Query 2: Calculate with explicit 365-day range
            const now = new Date();
            const from = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);

            const variables = {
              username: 'zashari',
              from: from.toISOString(),
              to: now.toISOString()
            };

            console.log(`Fetching contributions from ${from.toISOString()} to ${now.toISOString()}`);
            const responseWithDates = await github.graphql(queryWithDates, variables);
            const collection = responseWithDates.user.contributionsCollection;
            const explicitCount = collection.contributionCalendar.totalContributions;

            console.log(`Explicit 365-day range: ${explicitCount} contributions`);
            console.log(`Restricted contributions: ${collection.restrictedContributionsCount}`);
            console.log(`Commit contributions: ${collection.totalCommitContributions}`);
            console.log(`Issue contributions: ${collection.totalIssueContributions}`);
            console.log(`PR contributions: ${collection.totalPullRequestContributions}`);
            console.log(`PR Review contributions: ${collection.totalPullRequestReviewContributions}`);

            // Use the higher count (more likely to match what's shown on profile)
            const finalCount = Math.max(defaultCount, explicitCount);
            console.log(`Using final count: ${finalCount}`);

            core.setOutput('count', finalCount);

      - name: Update README with contribution count
        run: |
          COUNT="${{ steps.get_contributions.outputs.count }}"
          python3 << EOF
          import re
          import os

          count = os.environ.get('COUNT', '0')

          with open('README.md', 'r') as f:
              content = f.read()

          # Pattern: matches the HTML comment with any number inside
          # We only keep the number inside the comment, not before it
          pattern = r'<!-- CONTRIBUTIONS_COUNT -->\d+<!-- /CONTRIBUTIONS_COUNT -->'

          # Replace: update only the number inside the comment
          replacement = f'<!-- CONTRIBUTIONS_COUNT -->{count}<!-- /CONTRIBUTIONS_COUNT -->'
          content = re.sub(pattern, replacement, content, count=1)

          with open('README.md', 'w') as f:
              f.write(content)
          EOF
        env:
          COUNT: ${{ steps.get_contributions.outputs.count }}

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --quiet README.md || git add README.md && git commit -m "Update contribution count [skip ci]" && git push

